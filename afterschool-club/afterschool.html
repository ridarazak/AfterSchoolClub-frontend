<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Club</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!--Load Vue.js from a server (so no local file is needed)-->
    <script src="products.js"></script>
    <link rel="stylesheet" href="CSS.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

</head>

<body>
    <div id="app">
        <header>
            <div id="pagetitle">
                <h1 v-text ="sitename" style="color: olivedrab;"></h1>
            </div>

            <h3 style="display: inline-block;" id="searchbox">Search:</h3>
            <input type="text" v-model="searchQuery" placeholder="Search by subject or location" />

            <button v-on:click="showCheckout" id="checkbutton">
                {{cartItemCount}}
                <!--add the cart icon-->
                <span class="fa-solid fa-cart-arrow-down"></span> Checkout
            </button>
        </header>
        <div>
            <h3 style="color: beige;">Sort Options</h3>
            
            <label for="sortField" id="sort">Sort By:</label>
            <select id="sortField" v-model="selectedField">
                <option value="price">Price</option>
                <option value="subject">Subject</option>
                <option value="Location">Location</option>
                <option value="spacesAvailable">Spaces Available</option>
                <option value="rating">Rating</option>
            </select>
            
            <label for="sortOrder" id="sort">Order:</label>
            <select id="sortOrder" v-model="selectedOrder">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
            
            <button v-on:click="sortByField(selectedField, selectedOrder)">Sort</button>

        </div>
        
        <main>
            <div v-if="showProduct">
                <div class="productContainer">
                    <div v-for="product in filteredProducts" class="product">
                        <figure>
                            <!-- bind 'src' attr to 'product.image' in 'data'-->
                            <img v-bind:src="product.image">
                        </figure>
                        <h2 v-text="product.subject"></h2>
                        <p>Location: {{ product.Location }}</p>

                        <p>Space: {{ product.availableInventory - cartCount(product.id) }}</p>

            
                        <!-- The double curly brackets is used instead of 'v-text'-->
                        <p>Price (AED): {{product.price}}</p>
                        
                        <div>
                            <span>Rating:</span>
                            <span v-for="n in product.rating">★</span>
                            <span v-for="n in 5 - product.rating">☆</span>
                        </div>
                        <br>
        
                        <span v-if="product.availableInventory === cartCount(product.id)" class="status" style="color: red;">All Out!</span>
                        <span v-else-if="product.availableInventory - cartCount(product.id) < 5" class="status">
                            Only {{product.availableInventory - cartCount(product.id)}} left!
                        </span>
                        <span v-else class="status">Buy now!</span>
        
                        <button v-on:click="addToCart(product)" v-if="canAddToCart(product)">
                            Add to cart
                        </button>
        
                        <button disabled="disabled" v-else>
                            Add to cart
                        </button>
    
    
                        
                    </div>
                </div>
                
            </div>


            <div v-else id="checkoutBG">
                <h2 style="font-size: xx-large;">Checkout</h2>
                <br>

                <h3>Your Cart</h3>
                <div v-if="cart.length > 0" class="cartContainer">
                    <div v-for="(product, index) in cartProducts" :key="product.id" class="cartProduct">
                        <span><strong>{{ product.subject }};</strong> </span>
                        <span>Price: {{ product.price }}</span>
                        <button @click="removeFromCart(index)" style="background-color: red;">Remove</button>
                    </div>
                </div>
                <div v-else>
                    <p>Your cart is empty.</p>
                </div>
                <br>
                <br>
                
                <h3>Your Details</h3>
                <p>
                    <strong>First Name:</strong>
                    <input v-model="order.firstName" @input="validateName('firstName')" />
                    <p v-if="errors.firstName" class="error" style="color: red;">{{ errors.firstName }}</p>
                </p>
                <p>
                    <strong>Last Name:</strong>
                    <input v-model="order.lastName" @input="validateName('lastName')" />
                    <p v-if="errors.lastName" class="error" style="color: red;">{{ errors.lastName }}</p>
                </p>
                <p>
                    <strong>Phone Number:</strong>
                    <input v-model="order.phone" @input="validatePhone()" />
                    <p v-if="errors.phone" class="error" style="color: red;">{{ errors.phone }}</p>
                </p>

                <br>

                <h2 style="font-size: x-large;">Order Information</h2>
                <br>
                <p>First Name: {{order.firstName}}</p>
                <p>Last Name: {{order.lastName}}</p>
                <p>Phone Number: {{order.phone}}</p>

                <button v-on:click="submitForm">Place Order</button>
            </div>


        </main>
    </div>


    <script type="text/javascript">
        var webstore = new Vue({ 
            el:'#app', // The 'option object': DOM mounting point
            data: {
                showProduct: true,
                order: {
                    firstName:'',
                    lastName:'',
                    phone:''
                },
                sitename: 'After School Club',
                products: products,
                cart:[], //array to store items in shopping cart
                selectedField: 'price', // default sort field
                selectedOrder: 'asc',    // default sort order
                searchQuery: '',
                errors: { // Added to store error messages
                    firstName: '',
                    lastName: '',
                    phone: ''
                }     
            },
            methods:{
                addToCart(product){
                    this.cart.push(product.id)
                },
                showCheckout(){
                    this.showProduct = this.showProduct ? false : true;
                },
                canAddToCart(product){
                    return product.availableInventory > this.cartCount(product.id);
                },
                cartCount(id){
                    let count = 0;
                    for(let i = 0; i<this.cart.length; i++){
                        if(this.cart[i] === id){
                            count++;
                        }
                    }
                    return count;
                },
                removeFromCart(index) {
                    this.cart.splice(index, 1); // Remove the product from the cart based on index
                },
                validateName(field) {
                    const value = this.order[field];
                    const nameRegex = /^[a-zA-Z\s]*$/; // Only letters and spaces
                    this.errors[field] = nameRegex.test(value) ? '' : 'Name must contain letters only.';
                },
                
                validatePhone() {
                    const value = this.order.phone;
                    const phoneRegex = /^[0-9]*$/; // Only numbers
                    this.errors.phone = phoneRegex.test(value) ? '' : 'Phone number must contain digits only.';
                },
                submitForm() {
                    this.validateName('firstName');
                    this.validateName('lastName');
                    this.validatePhone();
                    
                    if (!this.errors.firstName && !this.errors.lastName && !this.errors.phone) {
                        alert('Order Submitted!');
                        this.resetForm();
                    } else {
                        alert('Please fix the errors before submitting.');
                    }
                },
                resetForm() {
                    this.order.firstName = '';
                    this.order.lastName = '';
                    this.order.phone = '';
                    this.errors = { firstName: '', lastName: '', phone: '' }; // Reset errors
                },
                sortByField(field, order) {
                    const modifier = order === 'asc' ? 1 : -1;

                    if (field === 'spacesAvailable') {
                        this.products.sort((a, b) => {
                            const spacesA = a.availableInventory - this.cartCount(a.id);
                            const spacesB = b.availableInventory - this.cartCount(b.id);
                            return (spacesA - spacesB) * modifier;
                        });
                    } else {
                        this.products.sort((a, b) => {
                            if (typeof a[field] === 'string') {
                                return a[field].localeCompare(b[field]) * modifier;
                            }
                            return (a[field] - b[field]) * modifier;
                        });
                    }
                }

            },
            computed:{//the computed property object
                cartItemCount(){
                    return this.cart.length;
                },
                cartProducts() {
                    return this.cart.map(id => {
                        return this.products.find(product => product.id === id);
                    }).filter(product => product); // Filter out any undefined values
                },
                filteredProducts() {
                    return this.products.filter(product => {
                        const searchTerm = this.searchQuery.toLowerCase();
                        return (
                            product.subject.toLowerCase().includes(searchTerm) ||
                            product.Location.toLowerCase().includes(searchTerm)
                        );
                    });
                },
            }
        });

    </script>
</body>
</html>